Part 1: General protocol information
====================================

IRCrypt only affects private messages and notices as defined by section 4.4 of
[rfc1459]. All other messages shall be passed unchanged by plug-ins
implementing IRCrypt. Furthermore, only the `<text>` part of these messages may
be modified.


### `IRCrypt message form`

An IRCrypt message has the following form.

    <PREFIX>-<PART-ID> <CRYPT-MSG>

Notice that the `<text>` part of a message has not to start with the IRCrypt
message, so that IRCrypt can also handle e.g. timestamps in front of an IRCrypt
message.


### `<PART-ID>`

`<PART-ID>` specifies the identifier of the message part. This is intended for
multipart messages and is a continuous descending integer value with a value of
0 indicating the last part of a message.

This means that for short messages, you can simply ignore this identifier and
just start the message with ¡È<PREFIX>-0¡É which tells your communication
partner that he can directly decrypt and display the message.

It may however be, that an already long message grows to large to send at once
via IRC after encryption, as one message may not exceed 512 characters
(including IRC protocol command identifier, trailing \CR\LF, etc.) as specified
in [rfc1459, sec.2.3]. In such a case it is necessary to split the encrypted
messages in multiple parts, sending them as separate IRCrypt messages (see
`IRCrypt message form`). Given that the message has to be split in N parts the
`<PART-ID>` of the first part to send is N, the second is N-1, ¡Ä until the
last part is send with `<PART-ID>` set to 0.

The descending order of the part ID ensures that:

 - The client knows how many parts will be send, making it possible to
	effectively allocate memory or, if the number of parts is to high for the
	client to handle, to refuse the messages.

 - The client can indicate and may throw away ¡Èold¡É message parts which
	were never completely transmitted, i.e. due to a failing connection. If, for
	example, a client receives messages preceded by ¡È<PREFIX>-2¡É and
	¡È<PREFIX>-1¡É but the next message is again preceded by
	¡È<PREFIX>-1¡É, the client knows that something is not right, may throw
	away the old message parts and try decoding the current message only.


### `<CRYPT-MSG>`

`<CRYPT-MSG>` is a message encrypted according to the OpenPGP standard
[rfc4880], Base64 encoded and cut into multiple parts (see `<PART-ID>`) if
nessecary.


### TIMEOUT

As using `<PART-ID>` greater than 0 should make a client keep these message
parts in memory while waiting for subsequent parts, this could be used as a
possible attack on clients: Sending such messages would cause a client to
constantly allocate new memory. However, subsequent message parts should be
send one after another over a short period of time. Thus is is not only valid
but recommended to discard old message parts after some time, if no subsequent
parts are being received.

Given the nature of IRC as ¡Èinstant¡É chat protocol, consecutive messages
should not be delayed very long and it should be reasonable to assume a message
to time out after five minutes.


Part 2: Symmetric Cipher
========================

### `<PREFIX>`

The prefix of symmetric encrypted messages is `>CRY`.


### `<CRYPT-MSG>`

The used cipher may be everything allowed by OpenPGP, nevertheless, it is
strongly suggested to use modern and secure ciphers like AES256 or TWOFISH. It would be also nice, if the user can choose the used cipher by him or herself.

Using GPG and the Unix base64 tool e.g. such a message can be generated by using the
following command

    echo 'Message' | gpg --symmetric --cipher-algo TWOFISH | base64 -w 0

and decrypted by using

	echo 'Encrypted Message' | base64 -d | gpg -d

### `Errors`

Not every Implementation of the OpenPGP standard has implemented the same
symmetric ciphers and the list of ciphers that has to be included to fullfill the
OpenPGP standard is very limited (see [rfc4880 8.2]). If an symmetric encrypted
IRCrypt message with an unknown cipher is received, the error

	>UCRY-CIPHER-NOT-FOUND

has to be sent back the notice.

### Example message

The following line contains a valid IRC Message from Angel to Wiz. It is
encrypted using the TWOFISH cipher with 256bits key size and ¡Èsecret¡É as
passphrase. The decrypted contents of this message is ¡ÈHello are you
receiving this message ?¡É:

    :Angel PRIVMSG Wiz :>CRY-0 jA0ECgMCpf88FdB5AdFg0lwB03DpHgpQAqoGSR2QTIynudCXM178TN2Y06ahv+I1i/mLwDMt+s021cb14YdVWJXUVqBKTbpQ3B3aIthsxsb0qrQoUTdZTKHjGYXeYPCFoRaetkOiEPUcAWK9RA==

Assuming that this message would be to long, the following two IRC messages
should produce the same output in Wizs IRC client:

    :Angel PRIVMSG Wiz :>CRY-1 jA0ECgMCpf88FdB5AdFg0lwB03DpHgpQAqoGSR2QTIynudCXM178TN2Y06ahv+I1i/mLwDMt+s02
    :Angel PRIVMSG Wiz :>CRY-0 1cb14YdVWJXUVqBKTbpQ3B3aIthsxsb0qrQoUTdZTKHjGYXeYPCFoRaetkOiEPUcAWK9RA==


Part 3: Asymmetric Cipher
=========================

### `<PREFIX>`

The prefix of symmetric encrypted messages is `>ACRY`.

### `<CRYPT-MSG>`

Remember that the user need to have the public key from the person she or he
wants to chat with. Using GPG and the Unix base64 tool such a message can be
generated by using the following command

    echo 'Message' | gpg -e -r <userid> | base64 -w 0

and decrypted by using

	echo 'Encrypted Message' | base64 -d | gpg -d

### `Errors`

If asymmetric encryption is not implemented, deactivated or something like
that, the error

	>UCRY-CIPHER-NOT-FOUND

has to be sent back as a notice.

PART 4: Key Exchange
====================
